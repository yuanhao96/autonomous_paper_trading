# Autonomous Evolving Investment System

A self-evolving US stock paper trading framework built on a dual-agent architecture. A **Trading Agent** ingests financial knowledge through a structured curriculum, builds and executes trading strategies, and evolves its own codebase over time. An **Auditor Agent** acts as an adversarial counterpart, inspecting strategies, backtests, and code changes for biases, data leakage, and self-deception. No real money is ever at risk -- all execution runs through Alpaca's paper trading API or a local mock broker.

## Architecture Overview

```
                    Human (iMessage / Slack / Web)
                         |
                         v
                  +----------------+
                  |  Preferences   |  (YAML -- human-controlled)
                  |  Permissions   |
                  +-------+--------+
                          |
              +-----------+-----------+
              v                       v
     +----------------+      +----------------+
     | Trading Agent  |      | Auditor Agent  |
     |                |      |                |
     | Learn theories |      | Learn biases   |
     | Build strategy |      | Learn exploits |
     | Execute trades |      | Inspect code   |
     | Evolve system  |      | Flag anomalies |
     +-------+--------+      +-------+--------+
             |                        |
             v                        v
     +----------------+      +------------------+
     | Code Changes   +----->| Audit Gate       |
     | + Backtests    |      | (must pass to    |
     +----------------+      |  deploy)         |
                              +--------+---------+
                                       |
                                       v
                               Live Paper Trading
```

The Trading Agent proposes strategies and code changes. The Auditor Agent reviews every proposal through a battery of checks (look-ahead bias, overfitting, survivorship bias, data quality). Only artefacts that pass the audit gate are promoted to live paper trading.

## Quick Start

### Prerequisites

- Python 3.11 or later
- An Anthropic API key (for LLM-driven knowledge synthesis and strategy generation)
- An Alpaca paper trading account (optional for V1 -- mock mode works without it)

### Installation

```bash
git clone https://github.com/yuanhao96/autonomous_paper_trading.git
cd autonomous_paper_trading
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### Environment Setup

Create a `.env` file in the project root:

```
ANTHROPIC_API_KEY=sk-ant-...
ALPACA_API_KEY=...           # optional for mock mode
ALPACA_SECRET_KEY=...        # optional for mock mode
ALPACA_BASE_URL=https://paper-api.alpaca.markets
```

### Running

```bash
# View current agent status (portfolio, curriculum stage, strategies)
python main.py --dry-run

# Run a daily trading cycle in mock mode (default, no Alpaca keys needed)
python main.py

# Run with real Alpaca paper trading API
python main.py --no-mock

# Focus on specific tickers
python main.py --tickers AAPL,MSFT,GOOG
```

## V1 Features

- **Knowledge Curriculum** -- Four-stage structured learning progression (Foundations, Strategy Families, Risk Management, Advanced) with per-topic mastery tracking in SQLite.
- **Paper Trading** -- Mock broker (local SQLite) or Alpaca paper trading API. Signals are generated by registered strategies, risk-checked, and executed automatically.
- **Starter Strategies** -- SMA Crossover (momentum) and RSI Mean Reversion ship out of the box.
- **Risk Management** -- Hard limits on position size, daily loss, and sector concentration derived from human-controlled preferences. The risk engine cannot be overridden by agents.
- **Walk-Forward Backtesting** -- Rolling train/test windows with equity curve tracking and performance metrics (Sharpe ratio, max drawdown, win rate, P&L).
- **Auditor Agent** -- Checks for look-ahead bias, overfitting, survivorship bias, and data quality. Strategy promotion requires passing the audit gate.
- **Daily Reports** -- Markdown-formatted performance summaries suitable for messaging delivery (iMessage, Slack, Telegram).
- **LLM Integration** -- Centralized Anthropic Claude API wrapper with automatic retries, exponential backoff, and structured call logging.
- **Semantic Knowledge Store** -- ChromaDB-backed vector database for storing and querying financial knowledge documents.

## Configuration Reference

### `config/preferences.yaml` (Human-Controlled)

This file is the agent's constitution. Only humans may edit it.

| Field | Description | Default |
|-------|-------------|---------|
| `risk_tolerance` | `conservative`, `moderate`, or `aggressive` | `moderate` |
| `max_drawdown_pct` | Maximum portfolio drawdown percentage | `15` |
| `trading_horizon` | `intraday`, `swing`, or `position` | `swing` |
| `target_annual_return_pct` | Target annual return percentage | `20` |
| `max_position_pct` | Maximum single-position size as percent of equity | `10` |
| `max_daily_loss_pct` | Daily loss limit; new buys are blocked when breached | `3` |
| `max_sector_concentration_pct` | Maximum exposure to a single sector | `30` |
| `evolution_permissions` | Per-module flags controlling what the evolution loop can modify | See file |

### `config/settings.yaml` (Runtime Configuration)

| Section | Key Fields |
|---------|------------|
| `llm` | `model` (default `claude-sonnet-4-6`), `max_retries`, `retry_base_delay` |
| `schedule` | Cron expressions for market scans, evaluations, reports, learning, evolution |
| `data` | `cache_dir`, `knowledge_dir`, `default_period`, `default_interval` |
| `database` | SQLite paths for trades, curriculum state, and agent state |
| `logging` | `llm_log_file`, `trade_log_file`, `level` |

## Roadmap

### V1 -- Foundation (current)

Knowledge ingestion and curriculum progression, simple paper trading with manually-approved strategies, daily performance reports, preferences YAML with human-only modification, and a basic auditor that checks backtest results for obvious biases.

### V2 -- Autonomous Strategy Development

The Trading Agent writes strategy code and indicators from its knowledge base. Walk-forward backtesting with agent-designed metrics. The Auditor reviews all code changes and backtest results. A promotion pipeline gates progression: backtest passes audit, paper-trades for N days, then auto-promotes.

### V3 -- Full Self-Evolution

The Trading Agent modifies its own framework (backtester, data pipelines, UI). A browser-based inspection dashboard is built by the agent. Architectural changes require auditor review plus human approval for major changes. The Auditor co-evolves, learning new audit techniques as the Trading Agent grows.

## Development

```bash
# Run all tests
pytest tests/ -v

# Lint
ruff check . && mypy .
```

For developer guidance, architecture details, and safety invariants, see [CLAUDE.md](CLAUDE.md).

## License

MIT
