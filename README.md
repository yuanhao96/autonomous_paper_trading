# Autonomous Evolving Investment System

A self-evolving US stock paper trading framework built on a dual-agent architecture. A **Trading Agent** ingests financial knowledge through a structured curriculum, builds and executes trading strategies, and evolves its own codebase over time. An **Auditor Agent** acts as an adversarial counterpart, inspecting strategies, backtests, and code changes for biases, data leakage, and self-deception. No real money is ever at risk -- all execution runs through Alpaca's paper trading API or a local mock broker.

## Architecture Overview

```
                    Human (iMessage / Slack / Web)
                         |
                         v
                  +----------------+
                  |  Preferences   |  (YAML -- human-controlled)
                  |  Permissions   |
                  +-------+--------+
                          |
              +-----------+-----------+
              v                       v
     +----------------+      +----------------+
     | Trading Agent  |      | Auditor Agent  |
     |                |      |                |
     | Learn theories |      | Learn biases   |
     | Build strategy |      | Learn exploits |
     | Execute trades |      | Inspect code   |
     | Evolve system  |      | Flag anomalies |
     +-------+--------+      +-------+--------+
             |                        |
             v                        v
     +----------------+      +------------------+
     | Code Changes   +----->| Audit Gate       |
     | + Backtests    |      | (must pass to    |
     +----------------+      |  deploy)         |
                              +--------+---------+
                                       |
                                       v
                               Live Paper Trading
```

The Trading Agent proposes strategies and code changes. The Auditor Agent reviews every proposal through a battery of checks (look-ahead bias, overfitting, survivorship bias, data quality). Only artefacts that pass the audit gate are promoted to live paper trading.

## Quick Start

### Prerequisites

- Python 3.11 or later
- A Moonshot (Kimi) API key from platform.moonshot.cn (for LLM-driven knowledge synthesis)
- An Alpaca paper trading account (paper trading is the default; use --mock for local SQLite testing)

### Installation

```bash
git clone https://github.com/yuanhao96/autonomous_paper_trading.git
cd autonomous_paper_trading
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

### Environment Setup

Create a `.env` file in the project root:

```
MOONSHOT_API_KEY=sk-...
ALPACA_API_KEY=...
ALPACA_SECRET_KEY=...
ALPACA_BASE_URL=https://paper-api.alpaca.markets
```

### Running

```bash
# View current agent status (portfolio, curriculum stage, strategies)
python main.py --dry-run

# Run a daily trading cycle (Alpaca paper trading is the default)
python main.py

# Use local SQLite mock broker instead of Alpaca
python main.py --mock

# Focus on specific tickers
python main.py --tickers AAPL,MSFT,GOOG

# Run a nightly learning session
python main.py --action learn

# Run one evolution cycle (generate → backtest → tournament → audit)
python main.py --action evolve
```

## V1 Features (Foundation)

- **Knowledge Curriculum** -- Four-stage structured learning progression (Foundations, Strategy Families, Risk Management, Advanced) with per-topic mastery tracked in markdown front-matter and assessed by LLM.
- **Curriculum Auto-Discovery** -- During `main.py --action learn`, high-signal concepts from synthesis can be auto-added to `config/curriculum.yaml` (deduped, capped per topic) so new topics enter future learning queues.
- **Paper Trading** -- Mock broker (local SQLite) or Alpaca paper trading API. Signals generated by registered strategies are risk-checked and executed automatically.
- **Starter Strategies** -- SMA Crossover (momentum) and RSI Mean Reversion ship out of the box.
- **Risk Management** -- Hard limits on position size, daily loss, and sector concentration derived from human-controlled preferences. The risk engine cannot be overridden by agents.
- **Walk-Forward Backtesting** -- Rolling train/test windows with equity curve tracking and performance metrics (Sharpe ratio, max drawdown, win rate, P&L).
- **Auditor Agent** -- Checks for look-ahead bias, overfitting, survivorship bias, and data quality. Strategy promotion requires passing the audit gate.
- **Daily Reports** -- Markdown-formatted performance summaries suitable for messaging delivery (iMessage, Slack, Telegram).
- **LLM Integration** -- Centralized Moonshot (Kimi) API wrapper (OpenAI-compatible) with automatic retries, exponential backoff, and structured call logging.
- **Markdown Knowledge Memory** -- Structured markdown files with YAML front-matter for storing synthesized financial knowledge. BM25 full-text search via `rank_bm25`. Git-versionable and human-readable.
- **Investment Book Library** -- 120+ curated trading and investment books (converted from PDF to plain text) mapped to curriculum topics. Each nightly learning session supplements Wikipedia/arXiv content with relevant book excerpts.

## V2 Features (Autonomous Strategy Development)

- **Indicator Library** -- 8 technical indicators (SMA, EMA, RSI, ADX, ATR, OBV, MACD, Bollinger Bands) implemented as pure-computation functions in `strategies/indicators.py`. Multi-output indicators (MACD, Bollinger) return `dict[str, Series]` with named keys.
- **Declarative Strategy Spec** -- LLM generates JSON strategy specs (`strategies/spec.py`), not raw Python. Specs declare indicators, entry/exit conditions (with 7 operators: `cross_above`, `cross_below`, `greater_than`, `less_than`, `between`, `slope_positive`, `percent_change`), and risk parameters. One level of indicator nesting and one level of condition nesting (ALL_OF / ANY_OF).
- **Template Engine** -- `strategies/template_engine.py` compiles a `StrategySpec` into an executable `TemplateStrategy` compatible with the existing backtester. Handles indicator dependency resolution, multi-output expansion, and composite condition evaluation.
- **LLM Strategy Generation** -- `strategies/generator.py` calls the LLM to produce batches of strategy specs. Each call uses a diversity index to encourage variety. Supports mutation of existing specs given auditor feedback.
- **Multi-Period Backtesting** -- `evaluation/multi_period.py` runs strategies across 6 historical regimes (GFC, Low-vol Grind, Melt-up + Vol Spike, COVID Cycle, Rate Hiking Bear, Current) with configurable weights. Composite score = weighted average Sharpe. Strategies failing a minimum Sharpe floor in any period are disqualified.
- **Tournament Selection** -- `evaluation/tournament.py` backtests a batch of compiled strategies, ranks them by composite score, and selects the top N survivors (default 3 of 10).
- **Auditor Layer 2 (LLM Analysis)** -- `agents/auditor/layer2.py` asks the LLM to write a Python analysis script, executes it in a sandboxed subprocess (timeout 30s, restricted env, no network), parses structured JSON findings, then generates constructive feedback for the planner.
- **Self-Evolving Auditor** -- Recurring Layer 2 patterns are tracked in SQLite. When a pattern occurs 3+ times with a false positive rate below 20%, it is auto-promoted to a Layer 1 check (`agents/auditor/checks/auto_*.py`).
- **Evolution Cycle Orchestration** -- `evolution/cycle.py` wires together: planner → generator → compiler → tournament → auditor → store. Limited to 1 cycle per day. Exhaustion detection flags plateau after N consecutive cycles with no score improvement.
- **Evolution Persistence** -- `evolution/store.py` uses SQLite to track cycles, strategy specs, audit feedback, and exhaustion state. Recent winners and feedback are fed back into the next generation cycle.
- **Evolved Strategy Loading** -- `strategies/registry.py` can load the most recent tournament survivors from the evolution store at agent startup, so evolved strategies participate in live paper trading.

## Learning Sources

Each nightly learning session draws from multiple source types per curriculum topic:

| Source | Used For | Details |
|--------|----------|---------|
| **Investment Books** | All stages | Excerpts from 120+ books in `~/projects/investment-books-text/`, mapped per topic in `config/books.yaml` |
| **Wikipedia** | Stage 1–2 (Foundations, Strategy Families) | Concept summaries via Wikipedia REST API |
| **Web Search** | All stages | DuckDuckGo search snippets + full article extraction via `ddgs` package (free, no API key) |
| **arXiv (q-fin)** | Stage 3–4 (Risk Management, Advanced) | Academic paper abstracts from the quantitative finance category |
| **Alpaca News** | Ongoing daily tasks | Real-time market news for the watchlist tickers via Alpaca News API |

### Book Library Setup

Convert the PDF library to plain text (one-time setup):

```bash
git clone --depth=1 https://github.com/bharaniabhishek123/some-investment-books.git ~/projects/some-investment-books
mkdir -p ~/projects/investment-books-text
find ~/projects/some-investment-books -name "*.pdf" | while IFS= read -r pdf; do
  pdftotext "$pdf" ~/projects/investment-books-text/"$(basename "$pdf" .pdf).txt" 2>/dev/null
done
```

The `config/books.yaml` file maps each curriculum `topic_id` to a list of relevant book filenames.
Override the books directory with the `BOOKS_DIR` environment variable.

### Knowledge Maintenance

PDF conversion sometimes produces empty or near-empty chunks (table-of-contents
lines, page numbers, single-word entries). Use the purge script to remove them:

```bash
# Dry-run — print what would be deleted (default)
python scripts/purge_junk_knowledge.py

# Also remove entire books where ≥ 80 % of parts are junk fragments
python scripts/purge_junk_knowledge.py --purge-bad-books

# Execute deletion
python scripts/purge_junk_knowledge.py --purge-bad-books --execute
```

| Flag | Default | Description |
|------|---------|-------------|
| `--dir` | `knowledge/memory/trading/discovered` | Target directory |
| `--threshold` | `100` | Minimum body character count to keep a file |
| `--purge-bad-books` | off | Delete all parts of books where ≥ `--book-junk-pct` % of parts are junk |
| `--book-junk-pct` | `80` | Junk-part percentage that triggers whole-book removal |
| `--execute` | off | Dry-run by default; add this flag to actually delete |

## Configuration Reference

### `config/preferences.yaml` (Human-Controlled)

This file is the agent's constitution. Only humans may edit it.

| Field | Description | Default |
|-------|-------------|---------|
| `risk_tolerance` | `conservative`, `moderate`, or `aggressive` | `moderate` |
| `max_drawdown_pct` | Maximum portfolio drawdown percentage | `15` |
| `trading_horizon` | `intraday`, `swing`, or `position` | `swing` |
| `target_annual_return_pct` | Target annual return percentage | `20` |
| `max_position_pct` | Maximum single-position size as percent of equity | `10` |
| `max_daily_loss_pct` | Daily loss limit; new buys are blocked when breached | `3` |
| `max_sector_concentration_pct` | Maximum exposure to a single sector | `30` |
| `evolution_permissions` | Per-module flags controlling what the evolution loop can modify | See file |

### `config/settings.yaml` (Runtime Configuration)

| Section | Key Fields |
|---------|------------|
| `llm` | `model` (default `claude-sonnet-4-5`), `max_retries`, `retry_base_delay` |
| `schedule` | Cron expressions for market scans, evaluations, reports, learning, evolution |
| `data` | `cache_dir`, `knowledge_dir`, `books_dir`, `web_search_max_results`, `web_search_fetch_articles` |
| `database` | SQLite paths for trades and agent state |
| `logging` | `llm_log_file`, `trade_log_file`, `level` |
| `learning` | Multi-round learning controls plus optional `auto_add_discovered_topics` (default true) and `auto_add_max_per_topic` (default 2) |
| `evolution` | `batch_size` (10), `survivor_count` (3), `max_cycles_per_day` (1), `min_sharpe_floor` (-0.5), `backtest_ticker` ("SPY"), `periods` (6 historical regimes with weights), `exhaustion_detection` (plateau detection config) |

## Evolution Cycle

The V2 evolution cycle is the core autonomous strategy development loop. Running `python main.py --action evolve` executes one full cycle:

```
Knowledge Base  ──►  Planner  ──►  LLM Generator (batch of 10 specs)
                                        │
                                        ▼
                                  Template Compiler
                                        │
                                        ▼
                              Multi-Period Backtester
                              (6 historical regimes)
                                        │
                                        ▼
                                Tournament Selection
                                  (top 3 survive)
                                        │
                                        ▼
                              Auditor (Layer 1 + Layer 2)
                                        │
                                        ▼
                              SQLite Persistence
                              (winners fed into next cycle)
```

Each cycle is limited to once per day. The planner feeds recent winners, past audit feedback, and knowledge summaries into the LLM prompt to improve diversity and quality over time. Exhaustion detection flags when the last N cycles show no score improvement.

## Roadmap

### V1 -- Foundation (complete)

Knowledge ingestion and curriculum progression, simple paper trading with manually-approved strategies, daily performance reports, preferences YAML with human-only modification, and a basic auditor that checks backtest results for obvious biases.

### V2 -- Autonomous Strategy Development (complete)

The LLM generates declarative JSON strategy specs (not raw Python). A template engine compiles specs into executable strategies. Multi-period backtesting across 6 historical regimes with tournament selection. The Auditor gains LLM-powered Layer 2 analysis with constructive feedback and self-evolving checks. Full evolution cycle orchestration with SQLite persistence.

### V3 -- Full Self-Evolution

The Trading Agent modifies its own framework (backtester, data pipelines, UI). A browser-based inspection dashboard is built by the agent. Architectural changes require auditor review plus human approval for major changes. The Auditor co-evolves, learning new audit techniques as the Trading Agent grows.

## Development

```bash
# Run all tests
pytest tests/ -v

# Lint
ruff check . && mypy .
```

For developer guidance, architecture details, and safety invariants, see [CLAUDE.md](CLAUDE.md).

## License

MIT
